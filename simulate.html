<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>סימולציית מצוקה – סגנון וואטסאפ</title>

  <!-- ======  BASIC WA-LIKE STYLING  ====== -->
  <style>
    :root{
      --wa-green:#00a884;          /* navbar / buttons */
      --wa-light:#dcf8c6;          /* outgoing bubble */
      --wa-bg:#eae6df;             /* chat background */
      --avatar-size:34px;
    }

    body{
      font-family:"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--wa-bg);
      margin:0;
      display:flex;
      justify-content:center;
      padding:2vh 0;
    }

    /* phone mock */
    .phone{
      width:370px;
      max-width:95vw;
      background:#fff;
      border-radius:22px;
      box-shadow:0 0 18px rgba(0,0,0,.2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:92vh;
    }

    /* ===== TOP BAR (with call & back) ===== */
    .top-nav{
      background:var(--wa-green);
      color:#fff;
      display:flex;
      flex-direction:row-reverse; /* RTL */
      align-items:center;
      gap:1rem;
      padding:.7rem 1rem;
    }
    .top-nav a{
      color:#fff;
      text-decoration:none;
      font-weight:bold;
      font-size:.95rem;
    }

    /* ===== HEADER TITLE ===== */
    h1{
      display:none; /* hidden – WA style uses only top bar */
    }

    /* ===== SCENARIO SELECTOR ===== */
    #scenarioContainer{
      background:#f0f2f5;
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
    }
    #scenarioContainer select{
      padding:.6rem .9rem;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:.95rem;
      background:#fff;
    }

    /* ===== CHAT WINDOW ===== */
    #chatContainer{
      flex:1;
      display:none;
      flex-direction:column;
      background:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2VhZTdkZiIvPjwvc3ZnPg==') repeat; /* light pattern */
      overflow:auto;
      padding:1rem .6rem 1rem .6rem;
    }

    /* ===== MESSAGE BUBBLE WRAPPER ===== */
    .message{
      display:flex;
      gap:.4rem;
      margin:.4rem 0;
      max-width:80%;
      font-size:.9rem;
      line-height:1.4;
    }
    /* avatar circle */
    .avatar{
      width:var(--avatar-size);
      height:var(--avatar-size);
      border-radius:50%;
      background:#fff;
      color:#555;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.1rem;
      flex:0 0 var(--avatar-size);
      box-shadow:0 0 2px rgba(0,0,0,.2);
    }
    /* bubble common */
    .bubble{
      padding:.55rem .9rem;
      border-radius:7.5px;
      position:relative;
      word-wrap:break-word;
      background:#fff;
    }

    /* outgoing (user) */
    .user{flex-direction:row-reverse;}
    .user .bubble{background:var(--wa-light);}
    .user .bubble:before{
      content:'';
      position:absolute;top:0;right:-6px;
      border:6px solid transparent;
      border-top-color:var(--wa-light);
      border-right:none;
      transform:translateY(4px);
    }

    /* incoming – friend/bot */
    .bot .bubble{background:#fff;}
    .bot .bubble:before{
      content:'';
      position:absolute;top:0;left:-6px;
      border:6px solid transparent;
      border-top-color:#fff;
      border-left:none;
      transform:translateY(4px);
    }

    /* feedback & evaluation */
    .feedback .bubble{background:#d8eeff;}
    .evaluation .bubble{
      background:#fff2b8;
      font-style:italic;
    }

    /* ===== INPUT AREA ===== */
    #inputContainer{
      display:flex;
      gap:.4rem;
      background:#f0f2f5;
      padding:.5rem .6rem;
    }
    #userInput{
      flex:1;
      border:none;
      border-radius:20px;
      padding:.55rem .9rem;
      font-size:.9rem;
      outline:none;
    }
    button.primary,button.secondary{
      border:none;
      border-radius:50%;
      width:42px;
      height:42px;
      color:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.2rem;
    }
    button.primary{background:var(--wa-green);}
    button.secondary{background:#888;}
  </style>
</head>
<body>
  <div class="phone">
    <!-- ===== TOP NAV ===== -->
    <nav class="top-nav">
      <a href="tel:1201">📞 ער"ן</a>
      <a href="mainpage.html">🏠 תפריט</a>
    </nav>

    <!-- ===== SCENARIO SELECTOR ===== -->
    <div id="scenarioContainer">
      <label for="scenarioSelect">בחר/י דמות (גיל + קשר):</label>
      <select id="scenarioSelect">
        <option value="" selected disabled>-- בחר/י --</option>
        <option value="10_student">ילד/ה בן/בת 10 – תלמיד/ה שלך</option>
        <option value="16_neighbor">מתבגר/ת בן/בת 16 – שכן/ית</option>
        <option value="22_classmate">צעיר/ה בן/בת 22 – חבר/ת כיתה</option>
        <option value="35_colleague">מבוגר/ת בן/בת 35 – קולגה</option>
        <option value="75_neighbor">קשיש/ה בן/בת 75 – שכן/ית</option>
      </select>
    </div>

    <!-- ===== CHAT AREA ===== -->
    <div id="chatContainer">
      <div id="instructionsDiv"></div>
      <div id="chat"></div>

      <!-- ===== INPUT BAR ===== -->
      <div id="inputContainer">
        <input id="userInput" type="text" placeholder="הקלד/י הודעה…" />
        <button id="sendBtn" class="primary">➤</button>
        <button id="evaluateBtn" class="secondary">★</button>
      </div>
    </div>
  </div>

  <!-- ===== SCRIPT ===== -->
  <script>
    // Elements
    const scenarioSelect    = document.getElementById('scenarioSelect');
    const scenarioContainer = document.getElementById('scenarioContainer');
    const chatContainer     = document.getElementById('chatContainer');
    const instructionsDiv   = document.getElementById('instructionsDiv');
    const chat              = document.getElementById('chat');
    const userInput         = document.getElementById('userInput');
    const sendBtn           = document.getElementById('sendBtn');
    const evaluateBtn       = document.getElementById('evaluateBtn');

    // Scenarios
    const scenarios={
      "10_student":{display:'אחה"צ בכיתה ריקה…',prompt:'את/ה תלמיד/ה בן/בת 10…'},
      "16_neighbor":{display:'ערב בשכונה…',prompt:'את/ה מתבגר/ת בן/בת 16…'},
      "22_classmate":{display:'לילה במעונות…',prompt:'את/ה סטודנט/ית בן/בת 22…'},
      "35_colleague":{display:'הפסקה בעבודה…',prompt:'את/ה עובד/ת בן/בת 35…'},
      "75_neighbor":{display:'שכן/ית ותיק/ה 75…',prompt:'את/ה קשיש/ה בן/בת 75…'}
    };

    // System prompts
    const quickFBSystem='אתה מנטור תומך. כתוב משוב חיובי קצר (≤6 מילים).';
    const summarySystem=`אתה פסיכולוג מדריך. תן סיכום:
• מחמאה
• מה עבד – 3–5
• לשיפור – 2–4
טון מחזק ואמפתי.`;

    let messages=[];
    let scenarioSystemPrompt='';

    // Init
    scenarioSelect.onchange=()=>{
      const key=scenarioSelect.value;
      if(!key) return;
      scenarioContainer.style.display='none';
      chatContainer.style.display='flex';
      instructionsDiv.textContent=scenarios[key].display;
      messages=[];
      scenarioSystemPrompt=scenarios[key].prompt;
      userInput.focus();
    };

    sendBtn.onclick=()=>handleSend();
    userInput.onkeyup=(e)=>{if(e.key==='Enter')handleSend();};
    evaluateBtn.onclick=()=>handleEvaluate();

    // helpers
    function addBubble(role,text){
      const wrap=document.createElement('div');
      wrap.className=`message ${role}`;
      // avatar
      const av=document.createElement('div');
      av.className='avatar';
      av.textContent=role==='user'?'😊':role==='bot'?'🤖':role==='feedback'?'⭐':'📝';
      // bubble
      const bub=document.createElement('div');
      bub.className='bubble';
      bub.textContent=text;
      // assemble
      wrap.appendChild(av);
      wrap.appendChild(bub);
      chat.appendChild(wrap);
      chat.scrollTop=chat.scrollHeight;
    }

    async function ai(payload){
      const r=await fetch('/api/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const d=await r.json();
      return d.text||'';
    }

    async function handleSend(){
      const txt=userInput.value.trim();
      if(!txt)return;
      addBubble('user',txt);
      messages.push({role:'user',content:txt});
      userInput.value='';

      // quick positive fb
      ai({messages:[{role:'system',content:quickFBSystem},{role:'user',content:txt}]})
        .then(f=>addBubble('feedback',f||'💪 יפה!')).catch(()=>{});

      // assistant reply
      const convo=[{role:'system',content:scenarioSystemPrompt},...messages];
      ai({messages:convo}).then(rep=>{
        addBubble('bot',rep||'…');
        messages.push({role:'assistant',content:rep});
      }).catch(()=>addBubble('bot','שגיאה 😕'));
    }

    async function handleEvaluate(){
      if(!messages.length)return;
      const userMsgs=messages.filter(m=>m.role==='user').map(m=>({role:'user',content:m.content}));
      const summary=await ai({messages:[{role:'system',content:summarySystem},...userMsgs]}).catch(()=>null);
      addBubble('evaluation',summary||'שגיאה בהערכה.');
    }
  </script>
</body>
</html>
