<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¡×™××•×œ×¦×™×™×ª ××¦×•×§×” â€“ ×¡×’× ×•×Ÿ ×•×•××˜×¡××¤</title>

  <!-- =====  WA-LIKE THEME  ===== -->
  <style>
    :root{
      --wa-green:#00a884;        /* navbar + send */
      --wa-light:#dcf8c6;        /* outgoing bubble */
      --wa-bg:#eae6df;           /* chat background */
      --avatar-size:34px;
    }
    body{margin:0;background:var(--wa-bg);display:flex;justify-content:center;padding:2vh 0;
         font-family:"Segoe UI",Roboto,Arial,sans-serif;}
    .phone{width:370px;max-width:95vw;height:92vh;background:#fff;border-radius:22px;
           box-shadow:0 0 18px rgba(0,0,0,.2);display:flex;flex-direction:column;overflow:hidden;}

    /* ===== NAVBAR ===== */
    .top-nav{background:var(--wa-green);color:#fff;display:flex;flex-direction:row-reverse;
             align-items:center;gap:1rem;padding:.7rem 1rem;font-weight:bold;font-size:.95rem;}
    .top-nav a{color:#fff;text-decoration:none;}

    /* ===== SELECTOR ===== */
    #scenarioContainer{background:#f0f2f5;padding:1rem;display:flex;flex-direction:column;gap:1rem;}
    #scenarioContainer select{padding:.6rem .9rem;border-radius:8px;border:1px solid #ccc;font-size:.95rem;}

    /* ===== CHAT ===== */
    #chatContainer{flex:1;display:none;flex-direction:column;background:var(--wa-bg);
                   overflow:auto;padding:1rem .6rem;}
    #instructionsDiv{background:#fff;border-radius:7.5px;padding:.6rem .9rem;margin-bottom:.8rem;
                     font-size:.85rem;color:#333;line-height:1.4;}

    .message{display:flex;gap:.4rem;margin:.4rem 0;max-width:80%;font-size:.9rem;line-height:1.35;}
    .message.user{flex-direction:row-reverse;}
    .avatar{width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;background:#fff;
            display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 0 2px rgba(0,0,0,.2);}
    .meta{display:block;font-size:.7rem;color:#666;margin-bottom:2px;font-weight:bold;}

    .bubble{position:relative;padding:.45rem .8rem;border-radius:7.5px;background:#fff;word-wrap:break-word;}
    .user .bubble{background:var(--wa-light);}
    .user .bubble:before{content:'';position:absolute;top:0;right:-6px;border:6px solid transparent;
                         border-top-color:var(--wa-light);border-right:none;transform:translateY(4px);}
    .bot .bubble:before{content:'';position:absolute;top:0;left:-6px;border:6px solid transparent;
                        border-top-color:#fff;border-left:none;transform:translateY(4px);}
    .evaluation .bubble{background:#fff2b8;font-style:italic;}
    .evaluation .bubble:before{content:'';position:absolute;top:0;left:-6px;border:6px solid transparent;
                               border-top-color:#fff2b8;border-left:none;transform:translateY(4px);}

    /* ===== INPUT BAR ===== */
    #inputContainer{display:flex;gap:.4rem;background:#f0f2f5;padding:.5rem .6rem;}
    #userInput{flex:1;border:none;border-radius:20px;padding:.55rem .9rem;font-size:.9rem;outline:none;}
    button{border:none;border-radius:50%;width:42px;height:42px;color:#fff;cursor:pointer;
           display:flex;align-items:center;justify-content:center;font-size:1.2rem;}
    button.primary{background:var(--wa-green);}  button.secondary{background:#888;}
  </style>
</head>
<body>
  <div class="phone">
    <!-- NAVBAR -->
    <nav class="top-nav">
      <a href="tel:1201">ğŸ“ ×¢×¨"×Ÿ</a>
      <a href="mainpage.html">ğŸ  ×ª×¤×¨×™×˜</a>
    </nav>

    <!-- SELECTOR -->
    <div id="scenarioContainer">
      <label for="scenarioSelect">×‘×—×¨/×™ ×“××•×ª (×’×™×œ + ×§×©×¨):</label>
      <select id="scenarioSelect">
        <option value="" selected disabled>-- ×‘×—×¨/×™ --</option>
        <option value="10_student">×™×œ×“/×” ×‘×Ÿ/×‘×ª 10 â€“ ×ª×œ××™×“/×” ×©×œ×š</option>
        <option value="16_neighbor">××ª×‘×’×¨/×ª ×‘×Ÿ/×‘×ª 16 â€“ ×©×›×Ÿ/×™×ª</option>
        <option value="22_classmate">×¦×¢×™×¨/×” ×‘×Ÿ/×‘×ª 22 â€“ ×—×‘×¨/×ª ×›×™×ª×”</option>
        <option value="35_colleague">××‘×•×’×¨/×ª ×‘×Ÿ/×‘×ª 35 â€“ ×§×•×œ×’×”</option>
        <option value="75_neighbor">×§×©×™×©/×” ×‘×Ÿ/×‘×ª 75 â€“ ×©×›×Ÿ/×™×ª</option>
      </select>
    </div>

    <!-- CHAT -->
    <div id="chatContainer">
      <div id="instructionsDiv"></div>
      <div id="chat"></div>

      <!-- INPUT -->
      <div id="inputContainer">
        <input id="userInput" type="text" placeholder="×”×§×œ×“/×™ ×”×•×“×¢×”â€¦" />
        <button id="sendBtn" class="primary">â¤</button>
        <button id="evaluateBtn" class="secondary">â˜…</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    /* ELEMENTS */
    const scenarioSelect    = document.getElementById('scenarioSelect');
    const scenarioContainer = document.getElementById('scenarioContainer');
    const chatContainer     = document.getElementById('chatContainer');
    const instructionsDiv   = document.getElementById('instructionsDiv');
    const chat              = document.getElementById('chat');
    const userInput         = document.getElementById('userInput');
    const sendBtn           = document.getElementById('sendBtn');
    const evaluateBtn       = document.getElementById('evaluateBtn');

    /* SCENARIOS â€“ ×”×‘×•×˜ ××’×™×‘ ×›×—×‘×¨/×” ×‘××¦×•×§×” */
    const scenarios={
      "10_student":{
        d:'××—×”"×¦ ×‘×›×™×ª×” ×¨×™×§×”. ×ª×œ××™×“/×” ×‘×œ×—×©: "××™×Ÿ ×œ×™ ×¢× ××™ ×œ×©×—×§â€¦"',
        p:`××ª/×” ×”×—×‘×¨/×” ×‘××¦×•×§×” â€“ ×™×œ×“/×” ×‘×Ÿ/×‘×ª 10. ×”××©×š/×™ ×œ×“×‘×¨ ×‘×’×•×£ ×¨××©×•×Ÿ ×‘×˜×•×Ÿ ×¢×¦×•×‘ ×•×œ×©×ª×£ ××™×š ××ª/×” ××¨×’×™×©/×”.`
      },
      "16_neighbor":{
        d:'×¢×¨×‘ ×‘×©×›×•× ×”. ××ª×‘×’×¨/×ª: "××£ ××—×“ ×œ× ××‘×™×Ÿ ××•×ª×™â€¦"',
        p:`××ª/×” ×”×—×‘×¨/×” ×‘××¦×•×§×” â€“ ××ª×‘×’×¨/×ª ×‘×Ÿ/×‘×ª 16. ×”××©×š/×™ ×œ×”×’×™×‘ ×‘×’×•×£ ×¨××©×•×Ÿ ×¢×œ ×ª×—×•×©×ª ×”×¨×™×—×•×§.`
      },
      "22_classmate":{
        d:'×œ×™×œ×” ×‘××¢×•× ×•×ª. ×—×‘×¨/×”: "×˜×•×‘×¢/×ª ×‘×—×•×‘×•×ªâ€¦" ',
        p:`××ª/×” ×”×—×‘×¨/×” ×‘××¦×•×§×” â€“ ×¡×˜×•×“× ×˜/×™×ª ×‘×Ÿ/×‘×ª 22. ×”××©×š/×™ ×œ×©×ª×£ ×‘×œ×—×¥ ×•×‘×§×•×©×™.`
      },
      "35_colleague":{
        d:'×”×¤×¡×§×” ×‘×¢×‘×•×“×”: "×”×¢×•××¡ ×©×•×‘×¨ ××•×ª×™â€¦" ',
        p:`××ª/×” ×”×—×‘×¨/×” ×‘××¦×•×§×” â€“ ×¢×•×‘×“/×ª ×‘×Ÿ/×‘×ª 35. ×”××©×š/×™ ×œ×ª××¨ ×ª×—×•×©×ª ×—× ×§ ×•××ª×—.`
      },
      "75_neighbor":{
        d:'×¦×”×¨×™×™×. ×©×›×Ÿ/×™×ª 75: "×”×‘×“×™×“×•×ª ×”×•×¨×’×ªâ€¦" ',
        p:`××ª/×” ×”×—×‘×¨/×” ×‘××¦×•×§×” â€“ ×§×©×™×©/×” ×‘×Ÿ/×‘×ª 75. ×”××©×š/×™ ×œ×©×ª×£ ×‘×ª×—×•×©×ª ×‘×“×™×“×•×ª ×•×›××‘.`
      }
    };

    /* SYSTEM PROMPT for evaluation */
    const summarySystem=`××ª×” ×¤×¡×™×›×•×œ×•×’ ××“×¨×™×š. ×ª×Ÿ ×¡×™×›×•× ×›×•×œ×œ:
â€¢ ××—×××” ×¨××©×™×ª
â€¢ ××” ×¢×‘×“ â€“ 3-5 × ×§×•×“×•×ª
â€¢ ×œ×©×™×¤×•×¨ â€“ 2-4 ×”×¦×¢×•×ª
×˜×•×Ÿ ××—×–×§ ×•×××¤×ª×™.`;

    /* STATE */
    let messages=[];
    let scenarioSystemPrompt='';

    /* EVENTS */
    scenarioSelect.onchange=()=>{
      const k=scenarioSelect.value;
      if(!k) return;
      scenarioContainer.style.display='none';
      chatContainer.style.display='flex';
      instructionsDiv.textContent=scenarios[k].d;
      messages=[];
      scenarioSystemPrompt=scenarios[k].p.trim();
      userInput.focus();
    };

    sendBtn.onclick   = handleSend;
    userInput.onkeyup = e=>{if(e.key==='Enter') handleSend();};
    evaluateBtn.onclick = handleEvaluate;

    /* HELPERS */
    const avatars={user:'ğŸ˜Š',bot:'ğŸ™',evaluation:'ğŸ“'};
    const labels ={user:'××ª/×”',bot:'×—×‘×¨/×”',evaluation:'×¡×™×›×•×'};

    function addBubble(role,text){
      const wrap=document.createElement('div');
      wrap.className=`message ${role}`;
      const av=document.createElement('div'); av.className='avatar'; av.textContent=avatars[role];
      const bub=document.createElement('div'); bub.className='bubble';
      const meta=document.createElement('span'); meta.className='meta'; meta.textContent=labels[role];
      bub.appendChild(meta); bub.appendChild(document.createTextNode(text));
      wrap.appendChild(av); wrap.appendChild(bub);
      chat.appendChild(wrap); chat.scrollTop=chat.scrollHeight;
    }

    async function ai(payload){
      const r=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const d=await r.json(); return d.text || '';
    }

    /* SEND */
    async function handleSend(){
      const txt=userInput.value.trim();
      if(!txt) return;

      addBubble('user',txt);
      messages.push({role:'user',content:txt});
      userInput.value='';

      /* FRIEND IN DISTRESS â€“ bot response */
      const convo=[{role:'system',content:scenarioSystemPrompt}, ...messages];
      ai({messages:convo})
        .then(rep=>{
          addBubble('bot',rep||'â€¦');
          messages.push({role:'assistant',content:rep});
        })
        .catch(()=>addBubble('bot','×©×’×™××” ğŸ˜•'));
    }

    /* EVALUATE */
    async function handleEvaluate(){
      if(!messages.length) return;
      const userMsgs=messages.filter(m=>m.role==='user').map(m=>({role:'user',content:m.content}));
      ai({messages:[{role:'system',content:summarySystem}, ...userMsgs]})
        .then(sum=>addBubble('evaluation',sum||'×©×’×™××” ×‘×”×¢×¨×›×”.'))
        .catch(()=>addBubble('evaluation','×©×’×™××” ×‘×”×¢×¨×›×”.'));
    }
  </script>
</body>
</html>
